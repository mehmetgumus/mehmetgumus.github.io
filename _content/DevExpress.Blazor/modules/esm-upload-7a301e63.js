import"./esm-chunk-eaca7b99.js";import{EnsureElement as e,AttachEventToElement as n,AddClassNameToElement as t,RemoveClassNameFromElement as o,DetachEventFromElement as i}from"./esm-dom-utils-57c82d80.js";import{D as r,R as a}from"./esm-chunk-f7983851.js";const s="chunkMetadata",u={WaitingStart:0,PendingUpload:1,Uploading:2,Paused:3,Complete:4,Canceled:5,Error:6,Removing:7},l={Instant:0,OnButtonClick:1};function f(s,u,l,f,d){var p;s=e(s),l=e(l),f=u.buttonCssSelector?document.querySelector(u.buttonCssSelector):e(f),u.dropZoneCssSelector&&(p=document.querySelector(u.dropZoneCssSelector)),l&&r(l),f&&r(f),p&&r(p);var h,m=null,v=null,E=null,F=null;return s.files||(s.files=[]),l&&(u.multiple&&l.setAttribute("multiple",""),u.acceptedFileTypes&&l.setAttribute("accept",u.acceptedFileTypes.join(",")),m=function(e){c(l.files,d,u).then(function(e){S(e,u,s,d),l.value=""})},n(l,"change",m),f&&n(f,"click",v=function(){l.click()}),p&&(E=function(e){e.preventDefault(),c(function(e,n){var t=[];if(e.items)for(var o=0,i=e.items[o];i;i=e.items[++o])"file"===i.kind&&i.type&&t.push(i.getAsFile());else for(var r=0,a=e.files[r];a;a=e.files[++r])t.push(a);return function(e,n){if(!e.length||!n)return e;const t=[],o=function(e){return e.map(e=>e.trim())}(n);for(let n=0,i=e.length;n<i;n++)g(e[n],o)&&t.push(e[n]);return t}(n.multiple?t:[t[0]],n.acceptedFileTypes)}(e.dataTransfer,u),d,u).then(function(e){S(e,u,s,d)}),h(e)},F=function(e){u.dragOverClassName&&t(e.srcElement,u.dragOverClassName),e.preventDefault()},h=function(e){u.dragOverClassName&&o(e.srcElement,u.dragOverClassName)},n(p,"drop",E),n(p,"dragover",F),n(p,"dragleave",h))),a(l,function(){m&&i(l,"change",m)}),f&&a(f,function(){i(f,"click",v)}),p&&a(p,function(){i(p,"drop",E),i(p,"dragover",F),i(p,"dragover",h)}),Promise.resolve("ok")}function c(e,n,t){return new Promise(function(o,i){n.invokeMethodAsync("CreateFileGuids",e.length).then(function(n){for(var i=[],r=0,a=e[r];a;a=e[++r]){var s=d(a,n[r],t);i.push(s)}o(i)})})}function d(e,n,t){var o={value:e,fileInfo:{name:e.name,size:e.size,type:e.type,guid:n},status:t.uploadMode===l.Instant?u.PendingUpload:u.WaitingStart,loadedBytes:0,isFileExtensionValid:p(e,t),isMinSizeValid:m(e,t),isMaxSizeValid:h(e,t),isValid:function(){return this.isFileExtensionValid&&this.isMaxSizeValid&&this.isMinSizeValid},isUploadComplete:function(){return this.loadedBytes>=this.fileInfo.size},loadStart:function(){this.status!==u.Uploading&&(this.status=u.Uploading,this.onLoadStart&&this.onLoadStart.call(this))},progress:function(){this.onProgress&&this.onProgress.call(this)},pause:function(){this.status=u.Paused,this.onPause&&this.onPause.call(this)},loadEnd:function(){this.isUploadComplete()&&(this.status=u.Complete,this.onLoadEnd&&this.onLoadEnd.call(this))},abort:function(){this.status!==u.Canceled&&(this.status=u.Canceled,this.request&&this.request.abort(),this.onAbort&&this.onAbort.call(this))},error:function(e){this.status=u.Error,this.onError&&this.onError.call(this,e)}};return o.isValid()&&t.uploadUrl||(o.status=u.Error),o}function p(e,n){const t=n.allowedFileExtensions,o=e.name.substring(e.name.lastIndexOf(".")).toLowerCase();if(0===t.length)return!0;for(let e=0;e<t.length;e++)if(o===t[e].toLowerCase())return!0;return!1}function h(e,n){const t=n.maxFileSize;return!(t>0)||e.size<=t}function m(e,n){const t=n.minFileSize;return!(t>0)||e.size>=t}function g(e,n){return n.some(function(n){if("."===n[0]){if(n=n.replace(".","\\."),e.name.match(new RegExp(n+"$","i")))return!0}else if(n=n.replace("*",""),e.type.match(new RegExp(n,"i")))return!0})}function S(e,n,t,o){0!==e.length&&(t.files=t.files.concat(e),y(t.files,o),e.forEach(function(e){v(e,n,t,o)}))}function v(e,n,t,o){e&&e.isValid()&&e.status!==u.WaitingStart&&e.status!==u.Error&&(!function(e,n){e.onLoadStart=function(){!function(e,n){z("FileUploadStarted",e,n)}(e,n)},e.onProgress=function(){!function(e,n){z("FileProgress",e,n)}(e,n)},e.onAbort=function(){!function(e,n){z("FileUploadAborted",e,n)}(e,n)},e.onPause=function(){!function(e,n){z("FileUploadPaused",e,n)}(e,n)},e.onError=function(t){!function(e,n,t,o){o.invokeMethodAsync("FileUploadError",C(e),n,t)}(e,t.status,t.statusText,n)},e.onLoadEnd=function(){!function(e,n){z("FileUploaded",e,n)}(e,n)}}(e,o),function(e){return e.chunkSize>0?E:F}(n).upload(e,n,function(e){e.loadEnd(),e.isUploadComplete()||e.status!==u.Uploading||v(e,n,t,o)}))}var E={upload:function(e,n,t){if(e){e.totalChunkCount||(e.chunkIndex=0,e.totalChunkCount=function(e,n){var t=Math.trunc(e/n.chunkSize);return e%n.chunkSize>0&&t++,t}(e.fileInfo.size,n));var o=n.chunkSize*e.chunkIndex,i=e.value.slice(o,o+n.chunkSize),r=function(e,n,t){let o=new FormData;return o.append(e,n),o.append(s,JSON.stringify({FileName:t.fileInfo.name,FileSize:t.fileInfo.size,FileType:t.fileInfo.type,FileGuid:t.fileInfo.guid,Index:t.chunkIndex,TotalCount:t.totalChunkCount})),o}(n.name,i,e);e.request=I.sendRequest(r,{url:n.uploadUrl,method:"POST",headers:[],onAbort:function(n){e.abort()},onProgress:function(e){},onError:function(n){e.error(n.target)},onLoadStart:function(n){e.loadStart()},onLoad:function(n){200===n.target.status?(e.chunkIndex++,e.loadedBytes+=i.size,e.progress(),t(e)):e.error(n.target)}})}}},F={upload:function(e,n,t){if(e){var o=function(e,n){let t=new FormData;return t.append(e,n.value),t}(n.name,e);e.request=I.sendRequest(o,{url:n.uploadUrl,method:"POST",headers:[],onProgress:function(n){e.loadedBytes=n.loaded>e.fileInfo.size?e.fileInfo.size:n.loaded,e.progress()},onAbort:function(n){e.abort()},onError:function(n){e.error(n.target)},onLoadStart:function(n){e.loadStart()},onLoad:function(n){200===n.target.status?t(e,n):e.error(n.target)}})}}},I={sendRequest:function(e,n,t){let o=new XMLHttpRequest;n.crossDomain=function(e){var n=!1,t=document.createElement("a"),o=document.createElement("a");t.href=window.location.href;try{o.href=e,o.href=o.href,n=t.protocol+"//"+t.host!=o.protocol+"//"+o.host}catch(e){n=!0}return n}(n.url);var i=function(e){var n=e.headers||{};return n.Accept=n.Accept||"*/*",e.crossDomain||n["X-Requested-With"]||(n["X-Requested-With"]="XMLHttpRequest"),n}(n);for(var r in o.open(n.method,n.url,!0),n.onLoadStart&&(o.upload.onloadstart=n.onLoadStart),n.onLoad&&(o.onload=n.onLoad),n.onLoadEnd&&(o.upload.onloadend=n.onLoadEnd),n.onProgress&&(o.upload.onprogress=n.onProgress),n.onError&&(o.upload.onerror=n.onError),n.onAbort&&(o.upload.onabort=n.onAbort),i)Object.prototype.hasOwnProperty.call(i,r)&&i[r]&&o.setRequestHeader(r,i[r]);return o.send(e),{abort:function(){o.abort()}}}};function y(e,n){n.invokeMethodAsync("SelectedFilesChanged",e.map(function(e){return C(e)}))}function z(e,n,t){t.invokeMethodAsync(e,C(n))}function C(e){return{Name:e.fileInfo.name,Size:e.fileInfo.size,Type:e.fileInfo.type,Guid:e.fileInfo.guid,LoadedBytes:e.loadedBytes,Status:e.status,IsFileExtensionValid:e.isFileExtensionValid,IsMinSizeValid:e.isMinSizeValid,IsMaxSizeValid:e.isMaxSizeValid}}function k(e,n,t,o){t.files.forEach(function(i){e.forEach(function(e){i.fileInfo.guid===e&&(i.status=u.PendingUpload,v(i,n,t,o))})})}function P(e,n,t,o){t.files.forEach(function(n){e.forEach(function(e){n.fileInfo.guid===e&&n.pause()})})}function b(e,n,t,o){t.files.forEach(function(n){e.forEach(function(e){n.fileInfo.guid===e&&n.abort()})})}function x(e,n,t,o){var i=t.files.filter(function(n){return e.indexOf(n.fileInfo.guid)>-1});0!==!i.length&&(t.files=L(t.files,e),c(i.map(function(e){return e.value}),o,n).then(function(i){t.files=t.files.concat(i),function(e,n,t){t.invokeMethodAsync("FileReloaded",e,n)}(e,i.map(function(e){return e.fileInfo.guid}),o),i.forEach(function(e){e.status=u.PendingUpload,v(e,n,t,o)})}))}function U(e,n,t,o){t.files=L(t.files,e),y(t.files,o)}function L(e,n){return e.filter(function(e){return-1===n.indexOf(e.fileInfo.guid)})}function A(n){if(n=e(n))return r(n),Promise.resolve("ok")}const M={Init:f,Dispose:A,StartFileUpload:k,PauseFileUpload:P,AbortFileUpload:b,RemoveFiles:U,ReloadFile:x};export default M;export{b as AbortFileUpload,A as Dispose,f as Init,P as PauseFileUpload,x as ReloadFile,U as RemoveFiles,k as StartFileUpload};
